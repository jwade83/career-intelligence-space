name: pr-babysitter
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
permissions:
  contents: write
jobs:
  attach-required-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
      - name: Ensure required PR checks attach (links, gate)
        env:
          REPO: ${{ github.repository }}
          SHA:  ${{ github.event.pull_request.head.sha }}
          BR:   ${{ github.head_ref }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          sleep 25
          states="$(gh api repos/$REPO/commits/$SHA/status                      --jq '[.statuses[]?|select(.context=="links" or .context=="gate")|.state]|join(",")'                      2>/dev/null || true)"
          echo "states=$states"
          if [ -z "$states" ] || echo "$states" | grep -q 'pending'; then
            echo "babysitter: nudging PR branch $BR"
            mkdir -p .github/keep
            date +%s >> .github/keep/pr-babysitter.keep
            git config user.name  "github-actions"
            git config user.email "github-actions@users.noreply.github.com"
            git add .github/keep/pr-babysitter.keep
            git commit -m "chore(ci): babysitter attach PR-event checks"
            git push origin HEAD:$BR
          else
            echo "babysitter: required checks already present"
          fi
