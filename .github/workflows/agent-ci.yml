name: Agent CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          curl -LO https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo install yq_linux_amd64 /usr/local/bin/yq
          rm yq_linux_amd64

      - name: Validate YAML files
        run: |
          shopt -s nullglob
          yaml_files=(agents/*.yml tasks/templates/*.yml)
          if [ ${#yaml_files[@]} -eq 0 ]; then
            echo "No YAML files found to validate"
            exit 0
          fi
          
          failed=0
          for file in "${yaml_files[@]}"; do
            if ! yq eval '.' "$file" > /dev/null 2>&1; then
              echo "::error file=$file::Invalid YAML syntax"
              failed=1
            fi
          done
          
          if [ $failed -eq 1 ]; then
            exit 1
          fi

      - name: Validate Markdown files
        run: |
          shopt -s nullglob
          md_files=(docs/*.md)
          if [ ${#md_files[@]} -eq 0 ]; then
            echo "No Markdown files found to validate"
            exit 0
          fi
          
          failed=0
          for file in "${md_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error file=$file::File not found"
              failed=1
            elif [ ! -s "$file" ]; then
              echo "::error file=$file::File is empty"
              failed=1
            fi
          done
          
          if [ $failed -eq 1 ]; then
            exit 1
          fi

      - name: Report results (PR)
        if: github.event_name == 'pull_request'
        run: |
          if [ $? -eq 0 ]; then
            echo "✅ All validation checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Validation checks failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update weekly review (main)
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p 99_LOGS
          echo "## $(date +'%Y-%m-%d %H:%M') - Agent CI Run" >> 99_LOGS/weekly_review.md
          if [ $? -eq 0 ]; then
            echo "✅ All validation checks passed" >> 99_LOGS/weekly_review.md
          else
            echo "❌ Validation checks failed" >> 99_LOGS/weekly_review.md
          fi
          echo "" >> 99_LOGS/weekly_review.md

      - name: Auto-commit weekly review
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add 99_LOGS/weekly_review.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update weekly review from CI"
            git push
          fi

# UPGRADE
